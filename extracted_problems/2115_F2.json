{
  "contestId": 2115,
  "index": "F2",
  "name": "Gellyfish and Lycoris Radiata (Hard Version)",
  "rating": 3500,
  "tags": [
    "implementation"
  ],
  "statement": "This is the hard version of the problem. The difference between the versions is that in this version, the time limit and the constraints on $$$n$$$ and $$$q$$$ are higher. You can hack only if you solved all versions of this problem. Gellyfish has an array consisting of $$$n$$$ sets. Initially, all the sets are empty. Now Gellyfish will do $$$q$$$ operations. Each operation contains one modification operation and one query operation, for the $$$i$$$-th ($$$1 \\leq i \\leq q$$$) operation: First, there will be a modification operation, which is one of the following: Insert operation: You are given an integer $$$r$$$. For the $$$1$$$-th to $$$r$$$-th sets, insert element $$$i$$$. Note that the element inserted here is $$$i$$$, the index of the operation, not the index of the set. Reverse operation: You are given an integer $$$r$$$. Reverse the $$$1$$$-th to $$$r$$$-th sets. Delete operation: You are given an integer $$$x$$$. Delete element $$$x$$$ from all sets that contain $$$x$$$. Followed by a query operation: Query operation: You are given an integer $$$p$$$. Output the smallest element in the $$$p$$$-th set (If the $$$p$$$-th set is empty, the answer is considered to be $$$0$$$). Now, Flower needs to provide the answer for each query operation. Please help her! Additional constraint on the problem : Gellyfish will only give the next operation after Flower has answered the previous query operation. That is, you need to solve this problem online . Please refer to the input format for more details.",
  "inputFormat": "The first line contains two integers $$$n$$$ and $$$q$$$ ($$$1 \\leq n, q \\leq 3 \\cdot 10^5$$$) — the number of the sets and the number of operations. As you need to respond to the operations online, the operations will be encoded. The $$$i$$$-th line of the following $$$q$$$ lines contains three integers $$$a$$$, $$$b$$$, and $$$c$$$ ($$$1 \\leq a \\leq 3$$$, $$$1 \\leq c \\leq n$$$) — describing the $$$i$$$-th operation in an encoded form. Here, $$$a$$$ represents the type of modification operation. Among them, $$$a=1$$$ represents Insert operation, $$$a=2$$$ represents Reverse operation, $$$a=3$$$ represents Delete operation. If $$$a = 1$$$, then the modification operation is the Insert operation. It will be guaranteed that $$$1 \\leq b \\leq n$$$. $$$r$$$ will be calculated as $$$r=(b+\\text{ans}_{i-1}-1) \\bmod n + 1$$$. If $$$a=2$$$, then the modification operation is the Reverse operation. It will be guaranteed that $$$1 \\leq b \\leq n$$$. $$$r$$$ will be calculated as $$$r=(b+\\text{ans}_{i-1}-1) \\bmod n + 1$$$. If $$$a=3$$$, then the modification operation is the Delete operation. It will be guaranteed that $$$1 \\leq b \\leq q$$$. $$$x$$$ will be calculated as $$$x=(b+\\text{ans}_{i-1}-1) \\bmod q + 1$$$. For the query operation, $$$p$$$ will be calculated as $$$p = (c+\\text{ans}_{i-1}-1) \\bmod n + 1$$$. Here $$$ \\text{ans}_{i} (1 \\leq i \\leq q)$$$ represents the answer to the query operation in the $$$i$$$-th operation. Additionally, we define $$$ \\text{ans}_{0} = 0$$$.",
  "outputFormat": "For each query operation, output the answer to the query.",
  "sampleTests": [
    {
      "input": "5 10\n1 2 2\n2 3 1\n1 5 3\n2 2 5\n1 5 2\n2 4 4\n3 2 2\n3 1 2\n3 10 5\n3 2 4",
      "output": "1\n0\n1\n1\n3\n1\n0\n5\n0\n0"
    }
  ],
  "timeLimit": 5000,
  "memoryLimit": 1024,
  "sourceUrl": "https://codeforces.com/problemset/problem/2115/F2",
  "verified": true,
  "qualityScore": 4.0,
  "source": "codeforces-scraped"
}